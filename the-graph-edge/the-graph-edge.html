<polymer-element name="the-graph-edge" attributes="source target route connection">
  <script>
    Polymer('the-graph-edge', {
      route: 0,
      zoom: 1,
      created: function () {
      },
      enteredView: function () {
        var graph = this.parentNode.parentNode;
        var self = this;
        graph.addEventListener("zoomed", function(event){
          self.zoom = graph.zoom;
        });
        setTimeout(this.checkParent.bind(this), 0);
      },
      checkParent: function () {
        var rootSVG = this.parentNode.$.edges;
        this.path = document.createElementNS("http://www.w3.org/2000/svg", "path");
        this.routeChanged();
        rootSVG.appendChild(this.path);
        this.drawEdge();
      },
      connectionChanged: function () {
        // Reference to the actual node list
        this.nodes = this.connection.nodes;

        // Other connection attributes
        this.source = this.connection.src.process + '.' + this.connection.src.port;
        this.target = this.connection.tgt.process + '.' + this.connection.tgt.port;
        if (this.connection.metadata) {
          this.route = this.connection.metadata.route;
        }
      },
      routeChanged: function () {
        if (!this.path) { return; }
        this.path.setAttributeNS(null, "class", "edge route"+this.route );
      },
      drawEdge: function () {
        if (!this.path || !this.from || !this.to) { return; }
        var outL = 3;
        var curveL = 20;
        if (this.to.x > this.from.x) {
          curveL = Math.floor((this.to.x-this.from.x)/2);
        }
        var d = [
          "M", this.from.x, this.from.y, 
          "L", this.from.x+outL, this.from.y,
          "C", this.from.x+outL+curveL, this.from.y,
               this.to.x-outL-curveL, this.to.y,
               this.to.x-outL, this.to.y,
          "L", this.to.x, this.to.y
        ].join(" ");
        this.path.setAttributeNS(null, "d", d );
      },
      sourceChanged: function () {
        var split = this.source.split(".");
        var sourceNode = document.getElementsByName( split[0] );
        if (sourceNode.length !== 1) { return; }
        this.sourceNode = sourceNode[0];
        this.sourceNode.addEventListener("moved", this.sourceMoved.bind(this));
        this.sourceMoved();
      },
      sourceMoved: function () {
        this.from = {
          x: Math.round( (parseFloat( this.sourceNode.getAttribute("x") ) + 60) * this.zoom ),
          y: Math.round( (parseFloat( this.sourceNode.getAttribute("y") ) + 30) * this.zoom )
        };
        this.drawEdge();
      },
      targetChanged: function () {
        var split = this.target.split(".");
        var targetNode = document.getElementsByName( split[0] );
        if (targetNode.length !== 1) { return; }
        this.targetNode = targetNode[0];
        this.targetNode.addEventListener("moved", this.targetMoved.bind(this));
        this.targetMoved();
      },
      targetMoved: function () {
        this.to = {
          x: Math.round( parseFloat( this.targetNode.getAttribute("x") ) * this.zoom ),
          y: Math.round( (parseFloat( this.targetNode.getAttribute("y") ) + 30) * this.zoom )
        };
        this.drawEdge();
      },
      zoomChanged: function () {
        this.from = {
          x: Math.round( (parseFloat( this.sourceNode.getAttribute("x") ) + 60) * this.zoom ),
          y: Math.round( (parseFloat( this.sourceNode.getAttribute("y") ) + 30) * this.zoom )
        };
        this.to = {
          x: Math.round( parseFloat( this.targetNode.getAttribute("x") ) * this.zoom ),
          y: Math.round( (parseFloat( this.targetNode.getAttribute("y") ) + 30) * this.zoom )
        };
        this.drawEdge();
      }


    });
  </script>
  
</polymer-element>
