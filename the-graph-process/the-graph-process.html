<link rel="import" href="../the-graph-inports/the-graph-inports.html">
<link rel="import" href="../the-graph-outports/the-graph-outports.html">
<polymer-element name="the-graph-process" attributes="label x y drag component process" lightdom>

  <template>
    <h1 class="the-graph-process-label">{{label}}</h1>
    <content select="the-graph-inports"></content>
    <content select="the-graph-outports"></content>
    <!-- 
    <the-graph-inports></the-graph-inports>
    <the-graph-outports></the-graph-outports>
    -->
  </template>

  <script type="text/javascript" src="../the-graph-util/the-graph-util.js"></script>

  <script>
    Polymer('the-graph-process', {
      created: function () {
        this.style.position = 'absolute';
      },
      enteredView: function () {
        var graph = this.parentNode.parentNode;
        var self = this;
        graph.addEventListener("zoomed", function(event){
          self.zoom = graph.zoom;
        });
      },
      label: '',
      x: 0,
      y: 0,
      drag: '',
      zoom: 1,
      width: 60,
      height: 60,
      processChanged: function () {
        this.component = this.process.component;
        this.name = this.process.name;
        if (this.process.metadata) {
          this.x = this.process.metadata.x;
          this.y = this.process.metadata.y;
        }
        if (!this.label) {
          this.label = this.name;
        }
      },
      xChanged: function () {
        this.positionChanged();
      },
      yChanged: function () {
        this.positionChanged();
      },
      dragChanged: function () {
        // TODO: Translate from view pixels to graph pixels
        var parts = this.drag.split(' ');
        this.x = parts[0] / this.zoom;
        this.y = parts[1] / this.zoom;
      },
      nameChanged: function () {
        this.setAttribute('name', this.name);
      },
      positionDebounce: null,
      positionChanged: function () {
        var later = function() {
          this.positionDebounce = null;
          theGraph.transform(this, this.x * this.zoom, this.y * this.zoom);
          this.fire('moved', {
            x: this.x,
            y: this.y
          });
        }.bind(this);
        clearTimeout(this.positionDebounce);
        this.positionDebounce = setTimeout(later, 16);
      },
      zoomChanged: function () {
        // Update width to a scaled value
        this.style.width = Math.round(this.width*this.zoom) + "px";
        this.style.height = Math.round(this.height*this.zoom) + "px";

        // Set position by screen pixels
        theGraph.transform(this, this.x * this.zoom, this.y * this.zoom);
      }

    });
  </script>
</polymer-element>

