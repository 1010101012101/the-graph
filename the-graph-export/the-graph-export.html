
<link rel="import" href="../the-graph-process/the-graph-process.html">
<link rel="import" href="../the-graph-edge/the-graph-edge.html">


<polymer-element name="the-graph-export" attributes="private public position label route snap" extends="the-graph-process">

  <script>
  /* jshint strict: false */
  (function(){
    // "use strict";

    Polymer('the-graph-export', {
      private: '',
      public: '',
      icon: '',
      directionalGestureEnabled: false,
      ready: function () {
        this.super();

        var pos = this.getPosition();
        this._position = [pos.x, pos.y];
        this.positionChanged();
        this.graphZoom(this.zoom);
      },
      enteredView: function () {
        this.super();
        this.connect();
      },
      waitingForLibrary: false,
      connect: function () {
        var pri = this.getPrivate();
        var node = this.graph.getNodeByName( pri.node );
        if (!node) {
          throw new Error("Export: node '" + pri.node + "' not found.");
        }
        var inport = node.getInportByName(pri.port);
        var outport = node.getOutportByName(pri.port);
        if (!inport && !outport) {
          // Wait for ports to change
          if (!this.waitingForLibrary) {
            node.addEventListener("ports", function(event){
              setTimeout(this.connect.bind(this), 100);
            }.bind(this));
            this.waitingForLibrary = true;
          }
          return;
        }
        if (inport && outport) {
          throw new Error("Ambiguous export '" + pri.port + "' ... please chime in at https://github.com/noflo/noflo/issues/118");
        }

        this.isImport = inport ? true : false;
      },
      isImportChanged: function(){
        this.icon = this.isImport ? 'sign-in' : 'sign-out';
        if (this.isImport) {
          // Imports have one outport
          this.inports = [];
          this.outports = [{name:"import",type:"all"}];
        } else {
          // Exports have one inport
          this.inports = [{name:"export",type:"all"}];
          this.outports = [];
        }
        // TODO make wire
      },
      getPrivate: function () {
        var split = this.private.split('.');
        return {
          node: split[0],
          port: split[1]
        };
      },
      highlightChanged: function () {
        // Don't highlight
        return;
      },
      toJSON: function () {
        var nodePos = this.getPosition();

        return {
          "public": this.public,
          "private": this.private,
          metadata: {
            x: nodePos.x,
            y: nodePos.y,
            route: this.route
          }
        };
      }

    });

  })();
  </script>
  
</polymer-element>
