<polymer-element name="the-graph" attributes="graph library width height">

  <template>
    <link rel="stylesheet" href="./the-graph-svg.css">
    <div id="svgcontainer"></div>
  </template>

  <script type="text/javascript" src="./the-graph.js"></script>
  <script type="text/javascript" src="./font-awesome-unicode-map.js"></script>
  <script type="text/javascript" src="./the-graph-app.js"></script>
  <script type="text/javascript" src="./the-graph-graph.js"></script>
  <script type="text/javascript" src="./the-graph-node.js"></script>
  <script type="text/javascript" src="./the-graph-node-menu.js"></script>
  <script type="text/javascript" src="./the-graph-node-menu-port.js"></script>
  <script type="text/javascript" src="./the-graph-node-menu-ports.js"></script>
  <script type="text/javascript" src="./the-graph-export-menu.js"></script>
  <script type="text/javascript" src="./the-graph-port.js"></script>
  <script type="text/javascript" src="./the-graph-port-menu.js"></script>
  <script type="text/javascript" src="./the-graph-edge.js"></script>
  <script type="text/javascript" src="./the-graph-edge-menu.js"></script>
  <script type="text/javascript" src="./the-graph-iip.js"></script>
  <script type="text/javascript" src="./the-graph-group.js"></script>
  <script type="text/javascript" src="./the-graph-tooltip.js"></script>
  <script type="text/javascript" src="./the-graph-menu.js"></script>

  <script>
  (function(){
    "use strict";

    Polymer('the-graph', {
      graph: null,
      library: {},
      width: 800,
      height: 600,
      appView: null,
      graphView: null,
      editable: true,
      ready: function () {
      },
      graphChanged: function () {
        // Listen for graph changes
        this.graph.on("endTransaction", this.fireChanged.bind(this));

        // Setup app
        this.$.svgcontainer.innerHTML = "";
        this.appView = React.renderComponent(
          window.TheGraph.App({
            graph: this.graph,
            width: this.width,
            height: this.height,
            library: this.library,
            editable: this.editable
          }),
          this.$.svgcontainer
        );
        this.graphView = this.appView.refs.graph;

        this.setupMenus(this.appView);
      },
      setupMenus: function (app) {
        app.addMenu("edge", {
          icon: "long-arrow-right"
        });
        app.addMenuAction("edge", "s4", {
          icon: "trash-o",
          iconLabel: "delete",
          action: function (graph, itemKey, item) {
            graph.removeEdge( item.from.node, item.from.port, item.to.node, item.to.port );
          }
        });
        app.addMenuAction("edge", "n4", {
          icon: "info",
          iconLabel: "info",
          action: function (graph, itemKey, item) {
            console.log("edge info", graph, itemKey, item);
          }
        });
      },
      fireChanged: function (event) {
        this.fire("changed", this);
      },
      widthChanged: function () {
        if (!this.appView) { return; }
        this.appView.setState({
          width: this.width
        });
      },
      heightChanged: function () {
        if (!this.appView) { return; }
        this.appView.setState({
          height: this.height
        });
      },
      rerender: function () {
        // This is throttled with rAF internally
        if (!this.graphView) { return; }
        this.graphView.markDirty();
      },
      addNode: function (id, component, metadata) {
        if (!this.graph) { return; }
        this.graph.addNode(id, component, metadata);
      },
      getPan: function () {
        if (!this.appView) { 
          return [0, 0]; 
        }
        return [this.appView.state.x, this.appView.state.y];
      },
      registerComponent: function (definition) {
        if (!this.library[definition.name]) {
          // New component, register
          this.library[definition.name] = definition;
          return;
        }
        // Update existing
        var component = this.library[definition.name];
        if (definition.description) {
          component.description = definition.description;
        }
        if (definition.icon) {
          component.icon = definition.icon;
        }
        definition.inports.forEach(function (defPort) {
          var port = null;
          component.inports.forEach(function (p) {
            if (p.name === defPort.name) {
              port = p;
            }
          });
          if (port) {
            port.type = defPort.type;
            return;
          }
          component.inports.push({
            name: defPort.name,
            type: defPort.type,
            array: defPort.array
          });
        });
        definition.outports.forEach(function (defPort) {
          var port = null;
          component.outports.forEach(function (p) {
            if (p.name === defPort.name) {
              port = p;
            }
          });
          if (port) {
            port.type = defPort.type;
            return;
          }
          component.outports.push({
            name: defPort.name,
            type: defPort.type,
            array: defPort.array
          });
        });
      },
      getComponent: function (name) {
        return this.library[name];
      },
      toJSON: function () {
        if (!this.graph) { return {}; }
        return this.graph.toJSON();
      }
    });

  })();
  </script>
</polymer-element>
